#### Recursive file integrity checkers

The md5deep program (also known as sha1deep, sha256deep, and so on for different hash algorithms) can recursively walk through directories (and into all contained subdirectories) to generate and check lists of hashes.

Run:

> sudo sha1deep -r /etc
>
> If the md5deep command is not available, install it:
>
> On openSUSE this can be done by first running 'cnf sha1deep', to find
> the name of the package containing the program, then run the install
> command it gives you, such as 'sudo zypper install md5deep'.
>
> If you get 'PackageKit is blocking zypper', then select 'no', and kill
> PackageKit, by running 'kill -9 *pid*', where *pid* is the number
> reported by the previous command. Now run the above again.
>
> If the zypper command is stuck on refreshing a repository, then press
> 'Ctrl-C', 'a' (for abort), then proceed with the installation as per
> normal.
>
> Once the required software is installed, try the sha1deep command
> again.

The output of the above command will include hashes of every file in /etc, which is where system-wide configuration files are stored on Unix.

Read the sha1deep manual to understand the above command:

> man sha1deep
>
> Figure out what the -r flag does.
>
> (Q to quit)

We can save (redirect) this output to a file so that we have a record of the current state of our system?s configuration:

> sudo sha1deep -r /etc &gt; /tmp/etc\_hashes

This may take a minute or so, while the program calculates the hashes and sends them to standard out (known as stdout), which is then redirected to the etc\_hashes file.

Next, let's compare the size of our list of hashes, with the actual content that we have hashed...

See how big our list of hashes is:

> ls -hs /tmp/etc\_hashes
>
> (-h = human readable, -s = size)

This is likely to be in the Kilobytes.

And for the size of all of the files in /etc:

> sudo du -hs /etc
>
> (-h = human readable, -s summarise)

This is likely in the Megabytes (or maybe even Gigabytes).

Clearly, the list of hashes is much smaller.

If you are **working with a classmate**, log into their system using ssh (as done previously). If you are working alone, simply run all the commands on your own system.

Create a new file somewhere in /etc/, containing your name. Name the file whatever you like (for example /etc/test), although the more inconspicuous the better.

> Hint: 'sudo vi /etc/test', 'i' to enter insert mode, and after typing your name, 'Esc', ':wq'.

Also, change an existing file in /etc on their system, but please do be careful to only make a minor change that will **not cause damage to their system**. For example, you could use vi to edit /etc/hostname ('sudo vi /etc/hostname'), and add a comment to the file such as '\#your-name: bet you can?t find this comment!'

You can now 'exit' the ssh session.

**On your own system**, lets try to identify what the 'attacker' has done to our system...

Now that we have a list of hashes of our files, use shasum to check if anything has changed using our newly generated list of hashes (/tmp/etc\_hashes).

> Hint: look at the previous command using shasum to check hashes.

Does this detect our the changed file AND the new file? Why not?

Md5deep/sha1deep takes a different approach to checking integrity, by checking all of the files it is told to check (possibly recursing over all files in a directory) against a list of hashes, and reporting whether any files it checked did not (or did, depending on the flags used) have its hash somewhere in the hash list.

Run sha1deep to check whether any files in /etc/ do not match a hash previously generated:

> sudo sha1deep -X /tmp/etc\_hashes -r /etc

This should detect both modified files, both new and modified.

But would sha1deep detect a copy of an existing file, to a new location?

Try it:

> sudo cp /etc/passwd /etc/passwd.backup

Now rerun the previous sha1deep command. Was the copy detected? Why not?

What about copying one file over another? Which out of shasum or sha1deep would detect that?

Another tool, hashdeep, which is included with md5deep, provides more coverage when it comes to detecting files that have moved, changed, or created.

Generate a hash list for /etc using hashdeep:

> sudo hashdeep -r /etc &gt; /tmp/etc\_hashdeep\_hashes

Hashdeep stores hashes in a different format than the previous tools. Have a look:

> less /tmp/etc\_hashdeep\_hashes
>
> (q to quit)
>
> Note that the output includes some more information, such as the file size for each file.

Delete the new file that your 'attacker' (the person who sshed into your system) created earlier:

> sudo rm /etc/*whatever-the-filename-was*

Conduct a hashdeep audit to detect any changes:

> sudo hashdeep -r -a -k /tmp/etc\_hashdeep\_hashes /etc
>
> Note, that this can take a while, so feel free to start working through the next section in another terminal, if you like.

After, run it again, this time asking for more details, since the default message does not provide any information as to why an audit has failed:

> sudo hashdeep -ra**vv** -k /tmp/etc\_hashdeep\_hashes /etc

Consult the man page for information about what each of the above flags do.
